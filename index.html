<!DOCTYPE html>
<html>
	<head>
	<title>See You Viewer</title>
		<link href="css/bootstrap.css" rel="stylesheet" media="screen">
		<link href="css/highlight/solarized_light.css" rel="stylesheet"/>
		<link href="css/tablesorter.css" rel="stylesheet">
		<style>
			body { padding: 1em; }
			div.progress { margin-bottom: 0px; }
			table { table-layout: fixed; }
 			table th, table td { overflow: hidden; }
 			#printinfo { display: none; }
 			@media print {
  				#summary_tab, #cases_tab, #navigation { display: none; }
  				#printinfo {
s  					display: block;
  					padding: 1em;
  					border: 1pt solid black;
  					margin-bottom: 1em;
  				}
			}
		</style>
		<script src="js/jquery.js"></script>
		<script src="js/bootstrap.js"></script>
		<script src="js/highlight.js"></script>
		<script src="js/mousetrap.js"></script>
		<script src="js/jquery.tablesorter.js"></script>
		<script src="js/jquery.tablesorter.widgets.js"></script>

		<script>var results = {};</script>
		<script src="results.js"></script>
		<script>
			console.log( results );

			var $info, $uid, $exercise, $case, $ip, $signature,
				$sources, $cases,
				$sources_tab, $cases_tab, $summary_tab;

			var current = {}, infos = [];

			Mousetrap.bind( 'q', function() { update_uid( -1 ); } );
			Mousetrap.bind( 'w', function() { $summary_tab.tab( 'show' ); } );
			Mousetrap.bind( 'r', function() { $( 'div.progress' ).toggle(); $( 'span.badge' ).toggle(); } );
			Mousetrap.bind( 'e', function() { update_uid( +1 ); } );

			Mousetrap.bind( 'a', function() { update_exercise( -1 ); } );
			Mousetrap.bind( 's', function() { $sources_tab.tab( 'show' ); } );
			Mousetrap.bind( 'd', function() { update_exercise( +1 ); } );

			Mousetrap.bind( 'z', function() { update_case( -1 ); } );
			Mousetrap.bind( 'x', function() { $cases_tab.tab( 'show' ); } );
			Mousetrap.bind( 'c', function() { update_case( +1 ); } );

			Mousetrap.bind( 'esc', function() { $summary_tab.focus(); } );

			function update_case( delta ) {
				var cases = results[ current.uid ].exercises[ current.exercise ].cases;
				if ( typeof delta !== 'undefined' ) {
					var t = current.case + delta;
					if ( 0 <= t && t < cases.length ) current.case = t;
					else return;
				}
				var cur = cases[ current.case ];
				$case.text( cur.name );
				var res = [];
				$.each( [ 'failure', 'error', 'stdout', 'stderr' ], function( i, e ) {
					if ( cur[ e ] != null ) res.push(
						$( '<div/>' ).html(
							'<span class="label">' + e + '</span>'
						).append(
							current.case > 0 ?
								$( '<pre/>' ).html( hljs.highlight( 'diff', cur[ e ] ).value )
							:
								$( '<pre/>' ).text( cur[ e ] )
						)
					);
				});
				if ( res.length > 0 ) {
					if ( current.case > 0 )
						$cases.html( '<div class="alert alert-error">problems found</div>' );
					else
						$cases.html( '<div class="alert alert-info">make output</div>' );
					$.each( res, function( i, r ) { $cases.append( r ) } );
				} else
					$cases.html( '<div class="alert alert-success">no problems found</div>' );
				$cases_tab.tab( 'show' );
			}

			function update_exercise( delta ) {
				var exercises = results[ current.uid ].exercises;
				if ( typeof delta !== 'undefined' ) {
					var t = current.exercise + delta;
					if ( 0 <= t && t < exercises.length ) current.exercise = t;
					else return;
				}
				var cur = exercises[ current.exercise ];
				$exercise.text( cur.name );
				var res = [];
				$.each( cur.sources, function( p ) {
					res.push( $( '<div/>' ).append(
						'<span class="label">' + p + '</span>'
					).append(
						$( '<pre/>' ).html( hljs.highlight( 'cpp', this ).value )
					));
				});
				if ( res.length > 0 ) {
					$sources.html( '' );
					$.each( res, function( i, s ) { $sources.append( s ) } );
				} else
					$sources.html( '<div class="alert alert-error">no source file found</div>' );
				current.case = 0;
				update_case();
				$sources_tab.tab( 'show' );
			}

			function update_uid( delta ) {
				if ( typeof delta !== 'undefined' ) {
					var t = current.uid + delta;
					if ( 0 <= t && t < results.length ) current.uid = t;
					else return;
				}
				var cur = results[ current.uid ];
				$uid.text( cur.uid );
				$info.val( cur.info );
				$ip.text( cur.ip );
				$signature.text( cur.signature.toString() );
				current.exercise = current.exercise || 0;
				update_exercise();
			}

			function compute_summary() {

				var ex_names = {};
				$.each( results, function( i, res ) {
					$.each( res.exercises, function( i, ex ) {
						ex_names[ ex.name ] = true;
					});
				});
				ex_names = Object.keys( ex_names ).sort();

				var head = $( 'thead>tr' );
				$.each( ex_names, function( i, name ) {
					head.append( $( '<th class="sorter-result"/>' ).text( name ) );
				});

				var body = $( 'tbody' );
				$.each( results, function( uid, res ) {
					var tr = $( '<tr/> ');
					tr.append( $( '<th/>').text( res.uid ) );
					tr.append( $( '<td/>').text( res.info ) );

					var s = {};
					$.each( res.exercises, function( i, ex ) {
						var n = {
							'sources': Object.keys( ex.sources ).length,
							'compile': 0,
							'execution': 0,
							'diff': 0,
							'ok': 0,
							'failure': 0,
						};
						$.each( ex.cases, function( i, cn ) {
							n[ cn.type ]++;
							if ( cn.failure ) n.failure += cn.failure.length;
						});
						n.tot = n.ok + n.diff + n.execution;
						s[ ex.name ] = n;
					});

					$.each( ex_names, function( ex, name ) {
						function _badge( k, l0, l1 ) {
							if ( sn[ k ] > 0 )
								td.append( $( '<span class="badge badge' + ( l0 !='' ? '-' + l0 : '' ) + '"/>' ).text( sn[ k ] ) );
							if ( typeof l1 !== 'undefined' )
								pb.append( $( '<div class="bar bar-' + l1 +'" style="width: ' + ( sn[ k ] * 100 / sn.tot ) +'%;"/>' ) );
						}
						var td = $( '<td/>' );
						td.click( (function( r, c ) { return function() {
							current.uid = uid, current.exercise = ex;
							update_uid();
							$sources_tab.tab( 'show' );
						} })( uid, ex ) );
						var pb = $( '<div class="progress"/>' );
						var sn = s[ name ];
						_badge( 'sources', '' );
						_badge( 'ok', 'success', 'success' );
						_badge( 'diff', 'important', 'danger' );
						_badge( 'failure', 'warning' );
						_badge( 'execution', 'info', 'info' );
						td.append( pb );
						tr.append( td );
					});

					body.append( tr );
				});

				$.tablesorter.addParser({
					id: 'result',
					is: function( s ) { return false; },
					format: function( s, table, cell, cellIndex ) {
						return $( cell ).children( '[class*="badge-success"]' ).text();
					},
					type: 'numeric'
	    		});
    			$( 'table' ).tablesorter({
    				theme: 'bootstrap',
					headerTemplate : '{content} {icon}',
					widgets : [ "uitheme" ],
    			});
				$( 'div.progress' ).toggle();
			}

			function fix_results() {

				function _cmp( a, b ) {
					return a.name < b.name ? -1 : ( a.name > b.name ? 1 : 0 );
				}
				function _edit( hash, func ) {
					var array = [];
					$.each( hash, function( key, val ) {
						func( key, val );
						array.push( val );
					});
					return array;
				}

				results = _edit( results, function( uid, res ) {
					res.uid = res.signature[ 0 ];
					res.info = res.signature[ 1 ];
					infos.push( res.info );
					res.ip = res.signature[ 2 ];
					var exercises = _edit( res.exercises, function( name, exercise ) {
						exercise.name = name;
						var cm = exercise.cases.shift()
						exercise.cases.sort( _cmp );
						exercise.cases.unshift( cm );
					});
					exercises.sort( _cmp );
					res.exercises = exercises;
				});

			}

			$(function() {

				$info = $( '#info' );
				$uid = $( '#uid' );
				$exercise = $( '#exercise' );
				$case = $( '#case' );
				$ip = $( '#ip' );
				$signature = $( '#signature' );

				$sources = $( '#sources' );
				$cases = $( '#cases' );

				$sources_tab = $( '#sections_nav a[href="#sources_tab"]' );
				$cases_tab = $( '#sections_nav a[href="#cases_tab"]' );
				$summary_tab= $( '#sections_nav a[href="#summary_tab"]' );

				fix_results();
				compute_summary();

				current.uid = 0;
				update_uid();
    			$summary_tab.tab( 'show' );

    			$info.typeahead({ source: infos });
    			$info.on( "focus", function( e ) { $info.val( '' ); } );
    			$info.on( "blur", function( e ) { $info.val( results[ current.uid ].info ); } );
    			$info.keypress( function( e ) {
					if ( e.which == 13 ) {
						var t = infos.indexOf( $info.val() );
						if ( t >= 0 ) {
							current.uid = t;
							update_uid();
						}
						$info.blur();
						e.preventDefault();
						return false;
					}
    			});

			});

		</script>
	</head>
	<body>
	<div class="container-fluid"><div class="row-fluid">

	<div class="span2" id="navigation">

		<form><fieldset>
		<label>UID</label>
		<span class="uneditable-input" id="uid"></span>
		<label>Info</label>
		<input type="text" id="info" autocomplete="off">
		<label>Exercise</label>
		<span class="uneditable-input" id="exercise"></span>
		<label>Case</label>
		<span class="uneditable-input" id="case"></span>
		<label>IP</label>
		<span class="uneditable-input" id="ip"></span>
		</fieldset></form>
		<hr/>
		<ul id="sections_nav" class="nav nav-pills nav-stacked">
			<li class="active"><a href="#summary_tab" data-toggle="tab">Summary</a></li>
			<li><a href="#sources_tab" data-toggle="tab">Sources</a></li>
			<li><a href="#cases_tab" data-toggle="tab">Cases</a></li>
		</ul>

	</div><!-- sidebar -->

	<div class="span10">

		<div id="sections_content" class="tab-content">
			<div class="tab-pane" id="summary_tab">
				<table class="table table-bordered table-striped">
					<thead>
						<tr><th width="10%">UID<th width="20%">Info
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
			<div class="tab-pane" id="sources_tab">
				<div id="printinfo">
					Signature: <span id="signature"></span>.
				</div>
				<div id="sources"></div>
			</div>
			<div class="tab-pane" id="cases_tab">
				<div id="cases"></div>
			</div>
		</div>

	</div><!-- body -->

	</div><!-- row --></div><!-- container -->
	</body>
</html>
