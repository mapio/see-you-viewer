<!DOCTYPE html>
<html>
	<head>
	<title>See You Viewer</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link href="css/bootstrap.min-16.css" rel="stylesheet" media="screen">
		<link href="css/select2.css" rel="stylesheet"/>
		<link href="css/highlight/solarized_light.css" rel="stylesheet"/>
		<style>
			body { padding: 1em; }
			div.progress { margin-bottom: 0px; }
			table { table-layout: fixed; }
 			table th, table td { overflow: hidden; }
		</style>
		<script src="js/jquery.js"></script>
		<script src="js/bootstrap.js"></script>
		<script src="js/select2.js"></script>
		<script src="js/mousetrap.js"></script>
		<script src="js/highlight.js"></script>
		<script src="results.js"></script>
		<script>

			var $seluid, $selex, $selcase,
				$sources, $cases, $summary,
				$suid, $sip,
				$nsources, $ncases, $nsummary;

			Mousetrap.bind( 'k', function() { $( 'div.progress' ).toggle(); $( 'span.badge' ).toggle(); } );
			Mousetrap.bind( 'q', function() { _uid( -1 ); } );
			Mousetrap.bind( 'w', function() { _uid( +1 ); } );
			Mousetrap.bind( 'a', function() { _ex( -1 ); } );
			Mousetrap.bind( 's', function() { _ex( +1 ); } );
			Mousetrap.bind( 'z', function() { _cn( -1 ); } );
			Mousetrap.bind( 'x', function() { _cn( +1 ); } );
			Mousetrap.bind( 'i', function() { $nsummary.tab( 'show' ); } );
			Mousetrap.bind( 'o', function() { $nsources.tab( 'show' ); } );
			Mousetrap.bind( 'p', function() { $ncases.tab( 'show' ); } );
			Mousetrap.bind( 'esc', function() { $nsummary.focus(); } );

			function _uid( delta ) {
				var uid = parseInt( $seluid.select2( "val" ) )
				if ( typeof delta !== 'undefined' ) {
					var new_uid = uid + delta;
					if ( 0 <= new_uid && new_uid < results.length )
						$seluid.select2( "val", new_uid );
				} else return uid;
			}

			function _exercises() {
				return results[ _uid() ].exercises;
			}

			function _ex( delta ) {
				var ex = parseInt( $selex.select2( "val" ) );
				if ( typeof delta !== 'undefined' ) {
					var new_ex = ex + delta;
					if ( 0 <= new_ex && new_ex < _exercises().length )
						$selex.select2( "val", new_ex );
				} else return ex;
			}

			function _cases() {
				return _exercises()[ _ex() ].cases;
			}

			function _cn( delta ) {
				var cn = parseInt( $selcase.select2( "val" ) );
				if ( typeof delta !== 'undefined' ) {
					var new_cn = cn + delta;
					if ( 0 <= new_cn && new_cn < _cases().length )
						$selcase.select2( "val", new_cn );
					$ncases.tab( 'show' );
				} else return cn;
			}

			function _go( uid, exercise ) {
				$seluid.select2( "val", uid );
				$selex.select2( "val", exercise );
				$nsources.tab( 'show' );
			}

			function update_case( e ) {
				var cn = _cn();
				var cc = _cases()[ cn ];
				var res = [];
				$.each( [ 'failure', 'error', 'stdout', 'stderr' ], function( i, e ) {
					if ( cc[ e ] != null ) res.push(
						$( '<div/>' ).html(
							'<span class="label">' + e + '</span>'
						).append(
							cn > 0 ?
								$( '<pre/>' ).html( hljs.highlight( 'diff', cc[ e ] ).value )
							:
								$( '<pre/>' ).text( cc[ e ] )
						)
					);
				});
				if ( res.length > 0 ) {
					if ( cn > 0 )
						$cases.html( '<div class="alert alert-error">problems found</div>' );
					else
						$cases.html( '<div class="alert alert-info">make output</div>' );
					$.each( res, function( i, r ) { $cases.append( r ) } );
				} else
					$cases.html( '<div class="alert alert-success">no problems found</div>' );
			}

			function update_exercise() {
				var ct = _exercises()[ _ex() ];
				var res = [];
				$.each( ct.sources, function( p ) {
					res.push( $( '<div/>' ).append(
						'<span class="label">' + p + '</span>'
					).append(
						$( '<pre/>' ).html( hljs.highlight( 'cpp', this ).value )
					));
				});
				if ( res.length > 0 ) {
					$sources.html( '' );
					$.each( res, function( i, s ) { $sources.append( s ) } );
				} else
					$sources.html( '<div class="alert alert-error">no source file found</div>' );
				$selcase.select2( "val", 0 );
			}

			function update_uid() {
				var sig = results[ _uid() ].signature;
				$suid.html( sig[ 0 ] );
				$sip.html( sig[ 2 ] );
				if ( isNaN( _ex() ) ) $selex.select2( "val", "0" );
				update_exercise();
			}

			function summary() {

				var ex_names = {};
				$.each( results, function( i, res ) {
					$.each( res.exercises, function( i, ex ) {
						ex_names[ ex.text ] = true;
					});
				});
				ex_names = Object.keys( ex_names ).sort();

				var head = $( 'thead>tr');
				$.each( ex_names, function( i, name ) {
					head.append( $( '<th/>' ).text( name ) );
				});

				var body = $( 'tbody' );
				$.each( results, function( uid, res ) {
					var tr = $( '<tr/> ');
					tr.append( $( '<th/>').text( res.uid ) );
					tr.append( $( '<td/>').text( res.text ) );

					var s = {};
					$.each( res.exercises, function( i, ex ) {
						var n = {
							'sources': Object.keys( ex.sources ).length,
							'compile': 0,
							'execution': 0,
							'diff': 0,
							'ok': 0,
							'failure': 0,
						};
						$.each( ex.cases, function( i, cn ) {
							n[ cn.type ]++;
							if ( cn.failure ) n.failure += cn.failure.length;
						});
						n.tot = n.ok + n.diff + n.execution;
						s[ ex.text ] = n;
					});
					$.each( ex_names, function( ex, name ) {
						function _badge( k, l0, l1 ) {
							if ( sn[ k ] > 0 )
								td.append( $( '<span class="badge badge' + ( l0 !='' ? '-' + l0 : '' ) + '"/>' ).text( sn[ k ] ) );
							if ( typeof l1 !== 'undefined' )
								pb.append( $( '<div class="bar bar-' + l1 +'" style="width: ' + ( sn[ k ] * 100 / sn.tot ) +'%;"/>' ) );
						}
						var td = $( '<td/>' );
						td.click( (function( r, c ) { return function() { _go( r, c ); } } )( uid, ex ) );
						var pb = $( '<div class="progress"/>' );
						var sn = s[ name ];

						_badge( 'sources', '' );
						_badge( 'ok', 'success', 'success' );
						_badge( 'diff', 'important', 'danger' );
						_badge( 'failure', 'warning' );
						_badge( 'execution', 'info', 'info' );
						td.append( pb );
						tr.append( td );
					});

					body.append( tr );
				});
				$( 'div.progress' ).toggle();

			}

			function fix_results() {

				function _addid( array ) {
					$.each( array, function( k, v ) { v.id = String( k ); } );
				}

				function _edit( hash, func ) {
					var id = 0;
					var array = [];
					$.each( hash, function( key, val ) {
						func( key, val );
						array.push( val );
					});
					return array;
				}

				results = _edit( results, function( uid, res ) {
					res.text = res.signature[ 1 ];
					res.uid = res.signature[ 0 ];
					var exercises = _edit( res.exercises, function( name, exercise ) {
						exercise.text = name;
						var cases = _edit( exercise.cases, function( idx, cn ) {
							cn[ 'text' ] = cn[ 'name' ];
						});
						_addid( cases );
						exercise.cases = cases;
					});
					exercises.sort(
						function( a, b ) { return a.text < b.text ? -1 : ( a.text > b.text ? 1 : 0 );
					});
					_addid( exercises );
					res.exercises = exercises;
				});
				_addid( results );

			}

			$(function() {

				$seluid = $( "#seluid" );
				$selex = $( "#selex" );
				$selcase = $( "#selcase" );
				$sources = $( '#sources' );
				$cases = $( '#cases' );
				$suid = $( '#suid' );
				$sip = $( '#sip' );
				$nsources = $( "#sections_nav a[href='#sources']" );
				$ncases = $( "#sections_nav a[href='#cases']" );
				$nsummary = $( "#sections_nav a[href='#summary']" );

				fix_results();
				summary();

				$seluid.select2({ data: results, width: 'resolve' }).on( "change", update_uid );

    			$selex.select2({
					width: 'resolve',
					initSelection: function( element, callback ) {
						callback( _exercises()[ element.val() ] );
					},
					query: function( query ) {
			        	query.callback( { results: _exercises() } );
    				}
    			}).on( "change", update_exercise );

    			$selcase.select2({
					width: 'resolve',
					initSelection: function( element, callback ) {
						callback( _cases()[ element.val() ] );
					},
					query: function( query ) {
			        	query.callback( { results: _cases() } );
    				}
    			}).on( "change", update_case );

    			$seluid.select2( "val", "0", true );

			});

		</script>
	</head>
	<body>
	<div class="container-fluid"><div class="row-fluid">

	<div class="span2">

		<form><fieldset>
		<label>Info</label>
		<input type="hidden" id="seluid"/>
		<label>Exercise</label>
		<input type="hidden" id="selex"/>
		<label>Case</label>
		<input type="hidden" id="selcase"/>
		</fieldset></form>
		<hr/>
		<label>UID</label>
		<span class="uneditable-input" id="suid"></span>
		<label>IP</label>
		<span class="uneditable-input" id="sip"></span>
		<hr/>
		<ul id="sections_nav" class="nav nav-pills nav-stacked">
			<li class="active"><a href="#summary" data-toggle="tab">Summary</a></li>
			<li><a href="#sources" data-toggle="tab">Sources</a></li>
			<li><a href="#cases" data-toggle="tab">Cases</a></li>
		</ul>

	</div><!-- sidebar -->

	<div class="span10">

		<div id="sections_content" class="tab-content">
			<div class="tab-pane " id="sources"></div>
			<div class="tab-pane" id="cases"></div>
			<div class="tab-pane active" id="summary">
				<table class="table table-bordered table-striped">
					<thead>
						<tr><th width="10%">UID<th width="20%">Info
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</div>

	</div><!-- body -->

	</div><!-- row --></div><!-- container -->
	</body>
</html>
