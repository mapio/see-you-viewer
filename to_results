#!/usr/bin/env python

from json import dumps
from logging import basicConfig, getLogger, INFO
from re import compile as recompile
from operator import itemgetter
from os import walk
from os.path import join, normpath
from sys import argv, stderr

basicConfig( format = '%(asctime)s %(levelname)s: %(funcName)s %(message)s', datefmt = '%Y-%m-%d %H:%M:%S', level = INFO )
LOGGER = getLogger( __name__ )

class FileSystemConverter( object ):

	def __init__( self, basedir = '.', **patterns ):
		_adjust = lambda _: recompile( join( self.basedir, patterns[ _ ] ) ) if _ in patterns else None
		self.basedir = normpath( basedir )
		self.signature_pattern = _adjust( 'signature' )
		self.source_pattern = _adjust( 'source' )
		self.cases_pattern = _adjust( 'cases' )

	def _signature( self, path ):
		if not self.signature_pattern: return None
		match = self.signature_pattern.match( path )
		if match:
			match = match.groupdict()
			LOGGER.info( 'match {0}'.format( match ) )
			with open( path, 'rb' ) as f: signature = unicode( f.read(), errors = 'replace' ).strip().split( '\t' )
			return match[ 'uid' ], signature
		return None

	def _source( self, path ):
		if not self.source_pattern: return
		match = self.source_pattern.match( path )
		if match:
			match = match.groupdict()
			LOGGER.info( ' match {0}'.format( match ) )
			with open( path, 'rb' ) as f: content = unicode( f.read(), errors = 'replace' )
			return match[ 'uid' ], match[ 'exercise' ], match[ 'source' ], content
		return None

	def _cases( self, path ):
		if not self.cases_pattern: return None
		match = self.cases_pattern.match( path )
		if match:
			match = match.groupdict()
			LOGGER.info( 'match {0}'.format( match ) )
			cases = [{
				'name': '',
				'stdout': '',
				'stderr': '',
				'failure': '',
				'error': '',
				'type': ''
			}]
			return match[ 'uid' ], match[ 'exercise' ], cases
		return None

	def scan( self ):
		exercise_names = set()
		results = {}
		def _ensure_result( uid, exercise = None ):
			if not uid in results:
				results[ uid ] = {
					'uid': uid,
					'info': uid,
					'ip': '',
					'exercises': {}
				}
			if exercise and not exercise in results[ uid ][ 'exercises' ]:
				results[ uid ][ 'exercises' ][ exercise ] = {
					'sources': {},
					'cases': []
				}
		for root, dirs, files in walk( self.basedir, followlinks = True ):
			for name in files:
				path = join( root, name )
				signature = self._signature( path )
				if signature:
					uid, signature = signature
					_ensure_result( uid )
					( results[ uid ][ 'uid' ],
					   results[ uid ][ 'info' ],
					   results[ uid ][ 'ip' ] ) = signature
					continue
				source = self._source( path )
				if source:
					uid, exercise, source, content = source
					exercise_names.add( exercise )
					_ensure_result( uid, exercise )
					results[ uid ][ 'exercises' ][ exercise ][ 'sources' ][ source ] = content
					continue
				cases = self._cases( path )
				if cases:
					uid, exercise, cases = cases
					_ensure_result( uid, exercise )
					results[ uid ][ 'exercises' ][ exercise ][ 'cases' ] = cases
		self.results = []
		for uid, res in results.items():
			exercises = []
			for exercise_name in exercise_names:
				try:
					exercise = res[ 'exercises' ][ exercise_name ]
				except KeyError:
					exercise = { 'name': exercise_name, 'sources': {}, 'cases': [] }
				exercise[ 'name' ] = exercise_name
				sources = []
				for source_name, source in exercise[ 'sources' ].items():
					sources.append( { 'name': source_name, 'content': source } )
				exercise[ 'sources' ] = sources
				exercises.append( exercise )
			res[ 'exercises' ] = exercises
			self.results.append( res )
		self.exercise_names = exercise_names
		return self

	def sort( self ):
		for res in self.results:
			res[ 'exercises' ].sort( key = itemgetter( 'name' ) )
			for exercise in res[ 'exercises' ]:
				if exercise[ 'cases' ]:
					first = exercise[ 'cases' ].pop( 0 )
					exercise[ 'cases' ].sort( key = itemgetter( 'name' ) )
					exercise[ 'cases' ].insert( 0, first )
				exercise[ 'sources' ].sort( key = itemgetter( 'name' ) )
		self.results.sort( key = itemgetter( 'uid' ) )
		return self

	def tojson( self ):
		return dumps( self.results )

if __name__ == '__main__':
	#FileSystemConverter( argv[ 1 ], source = r'(?P<uid>.*)/(?P<source>(?P<exercise>.*)\.java)' )
	converter = FileSystemConverter( argv[ 1 ],
		source = r'(?P<uid>.*)/latest/(?P<exercise>.*)/(?P<source>.*\.[ch])$',
		signature = r'(?P<uid>.*)/SIGNATURE\.tsv',
		cases = r'(?P<uid>.*)/latest/TEST-(?P=uid)\.(?P<exercise>.*)\.xml$',
	)
	print converter.scan().sort().tojson()
